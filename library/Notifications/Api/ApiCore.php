<?php

namespace Icinga\Module\Notifications\Api;

use GuzzleHttp\Psr7\Response;
use Icinga\Exception\Http\HttpException;
use Icinga\Module\Notifications\Api\Elements\HttpMethod;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\StreamInterface;
use Psr\Http\Server\RequestHandlerInterface;
use ValueError;

abstract class ApiCore implements RequestHandlerInterface
{
    /**
     * Handle the API request and return a ResponseInterface object.
     *
     * @param ServerRequestInterface $request
     *
     * @return ResponseInterface
     */
    abstract protected function handleRequest(ServerRequestInterface $request): ResponseInterface;

    /**
     * Get the name of the API endpoint.
     *
     * @return string
     */
    abstract public function getEndpoint(): string;

    /**
     * Handle the incoming server request and return a response.
     *
     * This method determines the HTTP method of the request and checks if the corresponding
     * method exists in the subclass. If the method does not exist,
     * it throws an HttpException with a 405 status code.
     *
     * @param ServerRequestInterface $request The incoming server request.
     *
     * @return ResponseInterface The response generated by the invoked method.
     *
     * @throws HttpException If the requested method does not exist.
     */
    public function handle(ServerRequestInterface $request): ResponseInterface
    {
        try {
            $httpMethod = HttpMethod::from(strtolower($request->getMethod()));
        } catch (ValueError) {
            throw (new HttpException(405, 'HTTP method ' . $request->getMethod() . ' is not supported'))
                ->setHeader('Allow', $this->getAllowedMethods());
        }
        $request = $request->withAttribute('httpMethod', $httpMethod);

        if (! method_exists($this, $httpMethod->lowercase())) {
            throw (new HttpException(
                405,
                'Method ' . $httpMethod->uppercase() . ' is not supported for endpoint ' . $this->getEndpoint()
            ))
                ->setHeader('Allow', $this->getAllowedMethods());
        }

        $this->assertValidRequest($request);

        return $this->handleRequest($request);
    }

    /**
     * Validate the incoming request.
     *
     * This method can be overridden in subclasses to implement API- or module-specific
     * request validation logic. By default, it does nothing.
     *
     * @param ServerRequestInterface $request The incoming server request to validate.
     *
     * @return void
     */
    protected function assertValidRequest(ServerRequestInterface $request): void
    {
    }

    /**
     * Get allowed HTTP methods for the API.
     *
     * @return string
     */
    protected function getAllowedMethods(): string
    {
        $methods = [];
        foreach (HttpMethod::cases() as $method) {
            if (method_exists($this, $method->lowercase())) {
                $methods[] = $method->uppercase();
            }
        }

        return implode(', ', $methods);
    }

    /**
     * Create a Response object.
     *
     * @param int $status The HTTP status code.
     * @param array $headers An associative array of HTTP headers.
     * @param ?(StreamInterface|resource|string) $body The response body.
     * @param string $version The HTTP version.
     * @param ?string $reason The reason phrase (optional).
     *
     * @return Response
     */
    protected function createResponse(
        int $status = 200,
        array $headers = [],
        $body = null,
        string $version = '1.1',
        ?string $reason = null
    ): Response {
        return new Response($status, $headers, $body, $version, $reason);
    }
}
